---
phase: 02-visual-atmosphere
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [app/components/AnimatedBackground.tsx, app/globals.css]
autonomous: false

must_haves:
  truths:
    - "Film grain overlay is visible and animating subtly across the viewport"
    - "Grain feels cinematic (organic, low-intensity) not like TV static (harsh, binary)"
    - "Grain runs smoothly on mobile without visible frame drops"
    - "Reduced-motion users see no grain animation"
  artifacts:
    - path: "app/components/AnimatedBackground.tsx"
      provides: "Film grain canvas overlay with mobile optimization"
      min_lines: 50
      contains: "renderGrain"
    - path: "app/globals.css"
      provides: "Grain canvas scaling CSS"
      contains: "mystery-static"
  key_links:
    - from: "AnimatedBackground.tsx"
      to: "canvas element"
      via: "requestAnimationFrame grain rendering at throttled fps"
      pattern: "requestAnimationFrame"
    - from: "AnimatedBackground.tsx"
      to: "matchMedia reduced-motion"
      via: "early return in useEffect"
      pattern: "prefers-reduced-motion"
    - from: "globals.css @media reduced-motion"
      to: ".mystery-static"
      via: "display: none hides grain canvas"
      pattern: "mystery-static.*display.*none"
---

<objective>
Replace the harsh TV static canvas with a subtle, organic film grain overlay optimized for mobile performance.

Purpose: Film grain adds cinematic texture that makes the dark atmosphere feel intentional and premium — like a movie, not a broken TV signal. Mobile optimization ensures the effect doesn't kill battery or cause frame drops.
Output: Updated AnimatedBackground component with film grain rendering, throttled framerate, and resolution scaling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-visual-atmosphere/02-01-SUMMARY.md

@app/components/AnimatedBackground.tsx
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace TV static with film grain canvas and optimize for mobile</name>
  <files>app/components/AnimatedBackground.tsx, app/globals.css</files>
  <action>
    **AnimatedBackground.tsx — Rewrite the grain rendering:**

    1. **Remove `staticIntensity` state** and the breathing useEffect entirely. Film grain has constant intensity — no "breathing" animation.

    2. **Remove `setStaticIntensity()` calls from the image flash useEffect** (lines ~112, 129). The image flash sequence stays unchanged otherwise — Phase 3 replaces it. Just remove the two staticIntensity manipulation lines.

    3. **Rewrite the TV static useEffect** as film grain:

       Key changes from TV static to film grain:
       - **Resolution**: Set canvas.width and canvas.height to a FRACTION of viewport (not 1:1). Use `Math.ceil(window.innerWidth / scale)` where scale = 4 on desktop, 8 on mobile (window.innerWidth <= 768). CSS handles upscaling. This is the biggest performance win.
       - **Noise type**: Use `Math.floor(Math.random() * 255)` for full grayscale range instead of binary `Math.random() > 0.5 ? 255 : 0`. Film grain is smooth tonal variation, not harsh black/white.
       - **Opacity**: Use constant alpha value of 12 per pixel (very subtle). Not the variable `Math.random() * 40 * staticIntensity * 10` from before.
       - **Framerate**: Throttle to ~15fps using timestamp check in rAF loop. TV static ran at 60fps (unnecessary for grain).

       Implementation pattern:
       ```
       const GRAIN_FPS = 15;
       const GRAIN_ALPHA = 12;

       useEffect(() => {
         if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
         const canvas = canvasRef.current;
         if (!canvas) return;
         const ctx = canvas.getContext('2d');
         if (!ctx) return;

         const resize = () => {
           const scale = window.innerWidth <= 768 ? 8 : 4;
           canvas.width = Math.ceil(window.innerWidth / scale);
           canvas.height = Math.ceil(window.innerHeight / scale);
         };
         resize();
         window.addEventListener('resize', resize);

         let animationId: number;
         let lastFrame = 0;
         const frameInterval = 1000 / GRAIN_FPS;

         const renderGrain = (timestamp: number) => {
           animationId = requestAnimationFrame(renderGrain);
           if (timestamp - lastFrame < frameInterval) return;
           lastFrame = timestamp;

           const imageData = ctx.createImageData(canvas.width, canvas.height);
           const data = imageData.data;
           for (let i = 0; i < data.length; i += 4) {
             const value = Math.floor(Math.random() * 255);
             data[i] = value;
             data[i + 1] = value;
             data[i + 2] = value;
             data[i + 3] = GRAIN_ALPHA;
           }
           ctx.putImageData(imageData, 0, 0);
         };

         requestAnimationFrame(renderGrain);

         return () => {
           window.removeEventListener('resize', resize);
           cancelAnimationFrame(animationId);
         };
       }, []);
       ```

       Note: The rAF callback now takes `timestamp` parameter (DOMHighResTimeStamp) instead of calling `Date.now()`. This is the correct pattern for rAF throttling.

    4. **globals.css — Add image-rendering to .mystery-static:**
       The grain canvas is now rendered at 1/4 or 1/8 resolution and scaled up by CSS. Without explicit image-rendering, browsers use bilinear filtering which makes the grain look blurry. Add `image-rendering: pixelated;` to .mystery-static to keep the grain sharp and visible. This gives a crisp film grain look.

    **DO NOT** remove or modify the image flash sequence (currentImage/imageOpacity state and the flash useEffect). Phase 3 replaces it.
    **DO NOT** change the reduced-motion CSS block — it already hides .mystery-static with display: none.
    **DO** keep the same JSX structure: fragment with conditional flash-image div + canvas element.
  </action>
  <verify>
    - npm run build succeeds
    - npm run lint has no new errors in AnimatedBackground.tsx
    - AnimatedBackground.tsx no longer references staticIntensity
    - AnimatedBackground.tsx contains renderGrain function with throttled rAF
    - globals.css .mystery-static contains image-rendering: pixelated
  </verify>
  <done>
    - TV static replaced with organic film grain
    - Canvas renders at 1/4 (desktop) or 1/8 (mobile) resolution for performance
    - Grain throttled to ~15fps
    - staticIntensity state and breathing useEffect removed
    - Image flash sequence preserved for Phase 3
    - Reduced-motion pattern intact
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete visual atmosphere: dark cinematic palette with neon green accents (Plan 01) + film grain overlay (Plan 02)</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000
    3. **Neon accents**: STREET logo should have a visible green glow halo. Background should have very subtle warm gradient (not flat black).
    4. **Film grain**: Subtle animated noise should be visible across the entire viewport. Should feel like film texture, not like a broken TV.
    5. **Form**: Focus on email/name inputs — border should turn neon green with subtle glow. Submit button should have ambient glow, brighter on hover.
    6. **Mobile**: Resize browser to ~375px width. Grain should still be visible and smooth (no stuttering or frame drops). Layout should remain centered.
    7. **Reduced motion**: Enable reduced motion in OS settings (macOS: System Settings > Accessibility > Display > Reduce motion). Page should show dark background, white text, form — NO grain animation, NO neon glow on logo.
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes (no new errors)
- [ ] Film grain visible and subtle (not harsh TV static)
- [ ] Grain smooth on simulated mobile viewport
- [ ] Reduced-motion hides grain correctly
- [ ] Visual verification approved by user
</verification>

<success_criteria>

- All tasks completed
- Visual atmosphere approved by user
- Film grain runs smoothly on mobile viewport
- No performance regressions (build output unchanged)
- Reduced-motion experience preserved
  </success_criteria>

<output>
After completion, create `.planning/phases/02-visual-atmosphere/02-02-SUMMARY.md`
</output>
